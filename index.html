<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç€è¦½å™¨æ¡Œé¢æé†’é¬§é˜ (é€²éšç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ React èˆ‡ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- è¼‰å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>

<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- åœ–ç¤ºçµ„ä»¶ ---
        const Clock = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
        );
        const Bell = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></svg>
        );
        const CheckCircle2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" /><path d="m9 12 2 2 4-4" /></svg>
        );
        const AlertCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>
        );
        const Plus = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14" /><path d="M12 5v14" /></svg>
        );
        const Trash2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>
        );
        const Repeat = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m17 2 4 4-4 4" /><path d="M3 11v-1a4 4 0 0 1 4-4h14" /><path d="m7 22-4-4 4-4" /><path d="M21 13v1a4 4 0 0 1-4 4H3" /></svg>
        );

        // --- ä¸»ç¨‹å¼é‚è¼¯ ---
        const RemindersApp = () => {
            const [reminders, setReminders] = useState([]);
            const [title, setTitle] = useState('');
            const [permission, setPermission] = useState(Notification.permission);
            const [currentTime, setCurrentTime] = useState(Date.now());

            // æ–°å¢ï¼šé‡è¤‡åŠŸèƒ½ç›¸é—œç‹€æ…‹
            const [isRepeating, setIsRepeating] = useState(false);
            const [targetTime, setTargetTime] = useState(''); // å–®æ¬¡æ¨¡å¼ç”¨ (å®Œæ•´æ—¥æœŸæ™‚é–“)
            const [startTime, setStartTime] = useState(''); // é–‹å§‹æ™‚é–“
            const [endTime, setEndTime] = useState(''); // çµæŸæ™‚é–“ï¼ˆé¸å¡«ï¼‰
            const [repeatTime, setRepeatTime] = useState(''); // é‡è¤‡æ¨¡å¼ç”¨ (åƒ…æ™‚é–“ HH:mm)
            const [repeatDays, setRepeatDays] = useState([]); // [0, 1, 2...] (0=é€±æ—¥)

            // è®€å–è³‡æ–™
            useEffect(() => {
                const savedData = localStorage.getItem('my-browser-reminders-v2');
                if (savedData) {
                    try {
                        setReminders(JSON.parse(savedData));
                    } catch (e) { console.error("è®€å–å¤±æ•—", e); }
                }

                // é¦–æ¬¡è¼‰å…¥æ™‚æª¢æŸ¥ protocol
                if (window.location.protocol === 'file:') {
                    console.warn('%c[å•Ÿå‹•è­¦å‘Š] ç›®å‰ä½¿ç”¨ "file://" å”å®šé‹è¡Œæœ¬åœ°æª”æ¡ˆï¼Œé€™å¯èƒ½æœƒå°è‡´æ¡Œé¢é€šçŸ¥åŠŸèƒ½è¢«ç€è¦½å™¨å®‰å…¨æ”¿ç­–é˜»æ“‹ã€‚è«‹æ”¹ç”¨æœ¬åœ°ä¼ºæœå™¨ (http://) æˆ–å°‡æª”æ¡ˆæ‹–æ›³åˆ°ç€è¦½å™¨åˆ†é åˆ—ä¾†é‹è¡Œï¼Œä»¥ç¢ºä¿é€šçŸ¥æ­£å¸¸å½ˆå‡ºã€‚', 'color: orange; font-size: 14px; font-weight: bold;');
                }

                // åŒæ­¥ç•¶å‰æ¬Šé™ç‹€æ…‹
                if ('Notification' in window) {
                    setPermission(Notification.permission);
                }

            }, []);

            // å„²å­˜è³‡æ–™
            useEffect(() => {
                localStorage.setItem('my-browser-reminders-v2', JSON.stringify(reminders));
            }, [reminders]);

            // è«‹æ±‚æ¬Šé™
            const requestPermission = async () => {
                // æª¢æŸ¥ Notification API æ˜¯å¦å¯ç”¨
                if (!('Notification' in window)) {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æ¡Œé¢é€šçŸ¥åŠŸèƒ½ã€‚è«‹ä½¿ç”¨ Chromeã€Edge æˆ– Firefoxã€‚');
                    return;
                }

                // å¦‚æœå·²ç¶“æœ‰æ¬Šé™
                if (Notification.permission === 'granted') {
                    setPermission('granted');
                    new Notification('æ¸¬è©¦é€šçŸ¥', { body: 'æ¡Œé¢é€šçŸ¥åŠŸèƒ½å·²å•Ÿç”¨ï¼' });
                    return;
                }

                // å¦‚æœå·²è¢«æ‹’çµ•ï¼Œå¼•å°ç”¨æˆ¶æ‰‹å‹•é–‹å•Ÿ
                if (Notification.permission === 'denied') {
                    alert('é€šçŸ¥æ¬Šé™å·²è¢«å°é–ã€‚\n\nè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ‰‹å‹•é–‹å•Ÿï¼š\n1. é»æ“Šç¶²å€åˆ—å·¦å´çš„ã€ŒğŸ”’ã€åœ–ç¤º\n2. æ‰¾åˆ°ã€Œé€šçŸ¥ã€é¸é …\n3. æ”¹ç‚ºã€Œå…è¨±ã€\n4. é‡æ–°æ•´ç†é é¢');
                    return;
                }

                // è«‹æ±‚æ¬Šé™
                try {
                    const result = await Notification.requestPermission();
                    setPermission(result);

                    if (result === 'granted') {
                        new Notification('æ¸¬è©¦é€šçŸ¥', { body: 'æ¡Œé¢é€šçŸ¥åŠŸèƒ½å·²å•Ÿç”¨ï¼' });
                    } else if (result === 'denied') {
                        alert('æ‚¨å·²æ‹’çµ•é€šçŸ¥æ¬Šé™ã€‚\n\nè‹¥è¦å•Ÿç”¨ï¼Œè«‹ï¼š\n1. é»æ“Šç¶²å€åˆ—å·¦å´çš„ã€ŒğŸ”’ã€åœ–ç¤º\n2. æ‰¾åˆ°ã€Œé€šçŸ¥ã€é¸é …\n3. æ”¹ç‚ºã€Œå…è¨±ã€\n4. é‡æ–°æ•´ç†é é¢');
                    } else {
                        // æ¬Šé™ä»ç‚º defaultï¼Œå¯èƒ½æ˜¯ç”¨æˆ¶é—œé–‰äº†å°è©±æ¡†
                        alert('æœªåµæ¸¬åˆ°æ¬Šé™è®Šæ›´ã€‚\n\nè‹¥ç€è¦½å™¨æ²’æœ‰å½ˆå‡ºæˆæ¬Šå°è©±æ¡†ï¼Œè«‹ï¼š\n1. é»æ“Šç¶²å€åˆ—å·¦å´çš„ã€ŒğŸ”’ã€åœ–ç¤º\n2. æ‰¾åˆ°ã€Œé€šçŸ¥ã€é¸é …\n3. æ”¹ç‚ºã€Œå…è¨±ã€\n4. é‡æ–°æ•´ç†é é¢');
                    }
                } catch (error) {
                    console.error('è«‹æ±‚é€šçŸ¥æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('è«‹æ±‚é€šçŸ¥æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚\n\nè«‹å˜—è©¦ï¼š\n1. é‡æ–°æ•´ç†é é¢\n2. ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
                }
            };

            // ç™¼é€é€šçŸ¥ (å·²åŠ å…¥é™¤éŒ¯æ—¥èªŒ)
            const sendNotification = (msg, taskTitle) => {
                if (Notification.permission === 'granted') {
                    console.log(`%c[é€šçŸ¥å·²è§¸ç™¼] ${msg} - äº‹é …: ${taskTitle}`, 'color: green; font-weight: bold;');
                    new Notification(msg, {
                        body: `äº‹é …ï¼š${taskTitle}`,
                        requireInteraction: true
                    });
                } else {
                    console.log(`%c[é€šçŸ¥å¤±æ•—] æ¬Šé™é grantedï¼Œå˜—è©¦ç™¼é€: ${msg} - äº‹é …: ${taskTitle}`, 'color: red; font-weight: bold;');
                    // ç‚ºäº†ç¢ºä¿ä½¿ç”¨è€…çŸ¥é“æ™‚é–“é‚è¼¯æ˜¯æ­£ç¢ºçš„ï¼Œå¯ä»¥åœ¨ Console é¡¯ç¤ºä¸€å€‹æ¨¡æ“¬é€šçŸ¥
                    if (window.location.protocol === 'file:') {
                        console.log(`%c[æ¨¡æ“¬é€šçŸ¥] æ™‚é–“å·²åˆ°ï¼Œä½†é€šçŸ¥è¢«é˜»æ“‹ã€‚è«‹æª¢æŸ¥ Console ç¢ºèªæ™‚é–“é‚è¼¯æ­£å¸¸ã€‚`, 'color: #3b82f6; background-color: #bfdbfe; padding: 5px; border-radius: 4px;');
                    }
                }
            };

            // --- æ ¸å¿ƒè¨ˆæ™‚å™¨ ---
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = Date.now();
                    const todayDateString = new Date().toDateString(); // ä¾‹å¦‚ "Fri Nov 19 2025"
                    const currentDay = new Date().getDay(); // 0-6 (0=é€±æ—¥)

                    setCurrentTime(now);

                    setReminders(prevReminders => prevReminders.map(task => {
                        // 1. è™•ç†ã€Œé‡è¤‡äº‹é …ã€çš„æ—¥æœŸé‚è¼¯
                        if (task.type === 'weekly') {
                            // æª¢æŸ¥ï¼šå¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è©²ä»»å‹™çš„é€šçŸ¥ç‹€æ…‹
                            if (task.lastResetDate !== todayDateString) {
                                return {
                                    ...task,
                                    lastResetDate: todayDateString,
                                    notified3Min: false,
                                    notified1Min: false,
                                    notified0Min: false,
                                    completed: false // é‡è¤‡äº‹é …æ¯å¤©é‡ç½®å®Œæˆç‹€æ…‹
                                };
                            }

                            // æª¢æŸ¥ï¼šä»Šå¤©æ˜¯å¦åœ¨è¨­å®šçš„æ˜ŸæœŸå¹¾å…§
                            if (task.repeatDays.includes(currentDay)) {
                                // çµ„åˆä»Šå¤©çš„æ—¥æœŸ + è¨­å®šçš„æ™‚é–“
                                const [h, m] = task.time.split(':');
                                const t = new Date();
                                // æª¢æŸ¥æ™‚é–“æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼Œé˜²æ­¢ç„¡æ•ˆæ—¥æœŸå°è‡´ NaN
                                if (isNaN(parseInt(h)) || isNaN(parseInt(m))) {
                                    console.error(`[éŒ¯èª¤] é‡è¤‡äº‹é …æ™‚é–“æ ¼å¼ç„¡æ•ˆ: ${task.time}`);
                                    return task;
                                }
                                t.setHours(h, m, 0, 0);
                                const targetTimestamp = t.getTime();
                                const diff = targetTimestamp - now;

                                let updates = {};
                                let shouldNotify = false;
                                let notifyMsg = "";

                                // å‰©é¤˜ 1~3 åˆ†é˜
                                if (diff <= 180000 && diff > 60000 && !task.notified3Min) {
                                    notifyMsg = `ã€å‰©é¤˜ 3 åˆ†é˜ã€‘æº–å‚™å¥½äº†å—ï¼Ÿ`;
                                    updates.notified3Min = true;
                                    shouldNotify = true;
                                }
                                // å‰©é¤˜ 0~1 åˆ†é˜
                                else if (diff <= 60000 && diff > 0 && !task.notified1Min) {
                                    notifyMsg = `ã€å‰©é¤˜ 1 åˆ†é˜ã€‘å³å°‡åˆ°æœŸï¼`;
                                    updates.notified1Min = true;
                                    shouldNotify = true;
                                }
                                // æ™‚é–“åˆ°
                                else if (diff <= 0 && !task.notified0Min) {
                                    const isTooLateForRepeating = diff < -1800000;
                                    if (!isTooLateForRepeating) {
                                        notifyMsg = `ã€æ™‚é–“åˆ°ã€‘è«‹åŸ·è¡Œäº‹é …ï¼`;
                                        shouldNotify = true;
                                    }
                                    updates.notified0Min = true;
                                    updates.completed = true;
                                }

                                if (shouldNotify) {
                                    sendNotification(notifyMsg, task.title);
                                    return { ...task, ...updates };
                                }
                                if (Object.keys(updates).length > 0) {
                                    return { ...task, ...updates };
                                }
                            }
                            return task;
                        }

                        // 2. è™•ç†ã€Œå–®æ¬¡äº‹é …ã€- æ”¯æ´é–‹å§‹/çµæŸæ™‚é–“
                        if (task.type === 'once') {
                            if (task.completed) return task;

                            let updates = {};

                            // è™•ç†é–‹å§‹æ™‚é–“é€šçŸ¥
                            const startTimestamp = new Date(task.startTime).getTime();
                            const diffStart = startTimestamp - now;

                            if (diffStart <= 180000 && diffStart > 60000 && !task.notifiedStart3Min) {
                                sendNotification(`ã€é–‹å§‹å‰ 3 åˆ†é˜ã€‘æº–å‚™å¥½äº†å—ï¼Ÿ`, task.title);
                                updates.notifiedStart3Min = true;
                            }
                            else if (diffStart <= 60000 && diffStart > 0 && !task.notifiedStart1Min) {
                                sendNotification(`ã€é–‹å§‹å‰ 1 åˆ†é˜ã€‘å³å°‡é–‹å§‹ï¼`, task.title);
                                updates.notifiedStart1Min = true;
                            }
                            else if (diffStart <= 0 && !task.notifiedStart0Min) {
                                sendNotification(`ã€é–‹å§‹æ™‚é–“åˆ°ã€‘è«‹é–‹å§‹åŸ·è¡Œï¼`, task.title);
                                updates.notifiedStart0Min = true;
                            }

                            // è™•ç†çµæŸæ™‚é–“é€šçŸ¥ï¼ˆè‹¥æœ‰è¨­å®šï¼‰
                            if (task.endTime) {
                                const endTimestamp = new Date(task.endTime).getTime();
                                const diffEnd = endTimestamp - now;

                                if (diffEnd <= 180000 && diffEnd > 60000 && !task.notifiedEnd3Min) {
                                    sendNotification(`ã€çµæŸå‰ 3 åˆ†é˜ã€‘å³å°‡çµæŸï¼`, task.title);
                                    updates.notifiedEnd3Min = true;
                                }
                                else if (diffEnd <= 60000 && diffEnd > 0 && !task.notifiedEnd1Min) {
                                    sendNotification(`ã€çµæŸå‰ 1 åˆ†é˜ã€‘æº–å‚™æ”¶å°¾ï¼`, task.title);
                                    updates.notifiedEnd1Min = true;
                                }
                                else if (diffEnd <= 0 && !task.notifiedEnd0Min) {
                                    sendNotification(`ã€çµæŸæ™‚é–“åˆ°ã€‘äº‹é …å·²çµæŸï¼`, task.title);
                                    updates.notifiedEnd0Min = true;
                                    updates.completed = true; // çµæŸæ™‚é–“åˆ°æ‰æ¨™è¨˜å®Œæˆ
                                }
                            } else {
                                // è‹¥æ²’æœ‰çµæŸæ™‚é–“ï¼Œé–‹å§‹æ™‚é–“åˆ°å°±æ¨™è¨˜å®Œæˆ
                                if (diffStart <= 0 && !task.completed) {
                                    updates.completed = true;
                                }
                            }

                            if (Object.keys(updates).length > 0) {
                                return { ...task, ...updates };
                            }
                            return task;
                        }

                        return task;
                    }));

                }, 1000);

                return () => clearInterval(timer);
            }, []);

            // æ–°å¢äº‹é …
            const handleAdd = (e) => {
                e.preventDefault();
                if (!title) return;

                let newTask = {
                    id: Date.now(),
                    title,
                    notified3Min: false,
                    notified1Min: false,
                    notified0Min: false,
                    completed: false,
                    lastResetDate: new Date().toDateString() // åˆå§‹åŒ–é‡ç½®æ—¥æœŸ
                };

                if (isRepeating) {
                    if (!repeatTime || repeatDays.length === 0) {
                        alert("è«‹è¨­å®šæ™‚é–“ä¸¦è‡³å°‘é¸æ“‡ä¸€å¤©æ˜ŸæœŸï¼");
                        return;
                    }

                    // Aæ–¹æ¡ˆé‚è¼¯ï¼šæª¢æŸ¥ä»Šå¤©çš„æ™‚é–“æ˜¯å¦å·²ç¶“å¤ªè¿‘
                    const now = new Date();
                    const [h, m] = repeatTime.split(':');
                    const todayTarget = new Date();
                    todayTarget.setHours(h, m, 0, 0);
                    const diff = todayTarget.getTime() - now.getTime();
                    const isToday = repeatDays.includes(now.getDay());

                    newTask = {
                        ...newTask,
                        type: 'weekly',
                        time: repeatTime, // "HH:mm"
                        repeatDays: repeatDays,
                        // å¦‚æœä»Šå¤©æ˜¯åŸ·è¡Œçš„æ—¥å­ï¼Œä¸”æ™‚é–“ < 3åˆ†é˜ï¼Œé å…ˆæ¨™è¨˜é¿å…é‡è¤‡è·³é€šçŸ¥
                        notified3Min: isToday && diff <= 180000,
                        notified1Min: isToday && diff <= 60000,
                    };

                } else {
                    if (!startTime) return;
                    const startTimestamp = new Date(startTime).getTime();
                    const now = Date.now();
                    const diffStart = startTimestamp - now;

                    if (diffStart < 0) {
                        alert("è«‹é¸æ“‡æœªä¾†çš„é–‹å§‹æ™‚é–“ï¼");
                        return;
                    }

                    // æª¢æŸ¥çµæŸæ™‚é–“æ˜¯å¦æœ‰æ•ˆ
                    let hasEndTime = false;
                    let diffEnd = 0;
                    if (endTime) {
                        const endTimestamp = new Date(endTime).getTime();
                        diffEnd = endTimestamp - now;
                        if (endTimestamp <= startTimestamp) {
                            alert("çµæŸæ™‚é–“å¿…é ˆåœ¨é–‹å§‹æ™‚é–“ä¹‹å¾Œï¼");
                            return;
                        }
                        hasEndTime = true;
                    }

                    newTask = {
                        ...newTask,
                        type: 'once',
                        startTime: startTime,
                        endTime: hasEndTime ? endTime : null,
                        // é–‹å§‹æ™‚é–“é€šçŸ¥ç‹€æ…‹
                        notifiedStart3Min: diffStart <= 180000,
                        notifiedStart1Min: diffStart <= 60000,
                        notifiedStart0Min: false,
                        // çµæŸæ™‚é–“é€šçŸ¥ç‹€æ…‹
                        notifiedEnd3Min: hasEndTime && diffEnd <= 180000,
                        notifiedEnd1Min: hasEndTime && diffEnd <= 60000,
                        notifiedEnd0Min: false,
                    };
                }

                setReminders([...reminders, newTask].sort((a, b) => a.id - b.id));

                // é‡ç½®è¡¨å–®
                setTitle('');
                // ä¿ç•™æ¨¡å¼é¸æ“‡ï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥ï¼Œä½†æ¸…ç©ºå…§å®¹
                if (!isRepeating) {
                    setStartTime('');
                    setEndTime('');
                }
                // é‡è¤‡æ¨¡å¼é€šå¸¸ä¸éœ€æ¸…ç©ºæ™‚é–“ï¼Œæ–¹ä¾¿è¨­å®šä¸‹ä¸€å€‹
            };

            const toggleDay = (dayIndex) => {
                if (repeatDays.includes(dayIndex)) {
                    setRepeatDays(repeatDays.filter(d => d !== dayIndex));
                } else {
                    setRepeatDays([...repeatDays, dayIndex].sort());
                }
            };

            const handleDelete = (id) => {
                setReminders(reminders.filter(r => r.id !== id));
            };

            const getDisplayText = (task) => {
                if (task.type === 'weekly') {
                    const weekMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                    const daysStr = task.repeatDays.map(d => weekMap[d]).join(', ');

                    // è¨ˆç®—å€’æ•¸
                    const currentDay = new Date().getDay();
                    const [h, m] = task.time.split(':');
                    const now = new Date();
                    const target = new Date();
                    target.setHours(h, m, 0, 0);

                    // å¦‚æœä»Šå¤©ä¸æ˜¯åŸ·è¡Œæ—¥ï¼Œæˆ–ä»Šå¤©æ˜¯ä½†æ™‚é–“å·²éä¸”å·²å®Œæˆ
                    if (!task.repeatDays.includes(currentDay)) {
                        return { time: `æ¯é€± ${daysStr} ${task.time}`, countdown: "éä»Šæ—¥åŸ·è¡Œ", color: "text-slate-400" };
                    }

                    const diff = target.getTime() - now.getTime();
                    if (diff <= 0) return { time: `æ¯é€± ${daysStr} ${task.time}`, countdown: "æœ¬æ—¥å·²çµæŸ", color: "text-slate-400" };

                    return {
                        time: `æ¯é€± ${daysStr} ${task.time}`,
                        countdown: formatCountdown(diff),
                        color: diff < 180000 ? "text-red-500" : "text-blue-600",
                        isUrgent: diff < 180000
                    };
                } else {
                    // å–®æ¬¡äº‹é … - é¡¯ç¤ºé–‹å§‹/çµæŸæ™‚é–“
                    const startTimestamp = new Date(task.startTime).getTime();
                    const diffStart = startTimestamp - currentTime;

                    let timeDisplay = `é–‹å§‹: ${new Date(task.startTime).toLocaleString()}`;
                    if (task.endTime) {
                        timeDisplay += ` â†’ çµæŸ: ${new Date(task.endTime).toLocaleString()}`;
                    }

                    // è¨ˆç®—ç•¶å‰æ‡‰è©²é¡¯ç¤ºçš„å€’æ•¸
                    if (diffStart > 0) {
                        // å°šæœªé–‹å§‹
                        return {
                            time: timeDisplay,
                            countdown: `é–‹å§‹å‰ ${formatCountdown(diffStart)}`,
                            color: diffStart < 180000 ? "text-red-500" : "text-blue-600",
                            isUrgent: diffStart < 180000,
                            phase: 'before-start'
                        };
                    } else if (task.endTime) {
                        // å·²é–‹å§‹ï¼Œè¨ˆç®—çµæŸæ™‚é–“
                        const endTimestamp = new Date(task.endTime).getTime();
                        const diffEnd = endTimestamp - currentTime;

                        if (diffEnd > 0) {
                            return {
                                time: timeDisplay,
                                countdown: `çµæŸå‰ ${formatCountdown(diffEnd)}`,
                                color: diffEnd < 180000 ? "text-orange-500" : "text-green-600",
                                isUrgent: diffEnd < 180000,
                                phase: 'in-progress'
                            };
                        } else {
                            return { time: timeDisplay, countdown: "å·²çµæŸ", color: "text-slate-400", phase: 'ended' };
                        }
                    } else {
                        return { time: timeDisplay, countdown: "å·²åˆ°æœŸ", color: "text-slate-400", phase: 'ended' };
                    }
                }
            };

            const formatCountdown = (diff) => {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                if (hours > 0) return `${hours}æ™‚ ${minutes}åˆ† ${seconds}ç§’`;
                return `${minutes}åˆ† ${seconds}ç§’`;
            };

            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            return (
                <div className="min-h-screen bg-slate-100 text-slate-800 p-4 md:p-8 font-sans">
                    <div className="max-w-3xl mx-auto">

                        {/* Header */}
                        <div className="flex items-center justify-between mb-8">
                            <h1 className="text-2xl md:text-3xl font-bold text-slate-900 flex items-center gap-3">
                                <Clock className="w-8 h-8 text-blue-600" />
                                ç€è¦½å™¨é¬§é˜ <span className="text-sm bg-blue-100 text-blue-600 px-2 py-1 rounded">é€²éšç‰ˆ</span>
                            </h1>

                            {permission !== 'granted' ? (
                                <button onClick={requestPermission} className="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg shadow animate-pulse">
                                    <Bell className="w-4 h-4" /> å•Ÿç”¨é€šçŸ¥
                                </button>
                            ) : (
                                <span className="flex items-center gap-2 text-green-600 bg-green-100 px-3 py-1 rounded-full text-sm font-medium">
                                    <CheckCircle2 className="w-4 h-4" /> é€šçŸ¥å·²å•Ÿç”¨
                                </span>
                            )}
                        </div>

                        {/* è¼¸å…¥å€ */}
                        <div className="bg-white p-6 rounded-xl shadow-md mb-8 border border-slate-200">
                            <div className="flex gap-4 mb-4 border-b border-slate-100 pb-4">
                                <button
                                    onClick={() => setIsRepeating(false)}
                                    className={`flex-1 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${!isRepeating ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                                >
                                    <Clock className="w-4 h-4" /> å–®æ¬¡æé†’
                                </button>
                                <button
                                    onClick={() => setIsRepeating(true)}
                                    className={`flex-1 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${isRepeating ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                                >
                                    <Repeat className="w-4 h-4" /> æ¯é€±é‡è¤‡
                                </button>
                            </div>

                            <form onSubmit={handleAdd} className="flex flex-col gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-500 mb-1">æé†’äº‹é …</label>
                                    <input
                                        type="text"
                                        placeholder="ä¾‹å¦‚ï¼šæ¯é€±æœƒè­°ã€å€’åƒåœ¾ã€æ¶ç¥¨"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        required
                                    />
                                </div>

                                {!isRepeating ? (
                                    // å–®æ¬¡æ¨¡å¼è¼¸å…¥
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-500 mb-1">é–‹å§‹æ™‚é–“</label>
                                            <input
                                                type="datetime-local"
                                                value={startTime}
                                                onChange={(e) => setStartTime(e.target.value)}
                                                className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                                required={!isRepeating}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-500 mb-1">çµæŸæ™‚é–“ <span className="text-slate-400">(é¸å¡«)</span></label>
                                            <input
                                                type="datetime-local"
                                                value={endTime}
                                                onChange={(e) => setEndTime(e.target.value)}
                                                className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            />
                                        </div>
                                    </div>
                                ) : (
                                    // é‡è¤‡æ¨¡å¼è¼¸å…¥
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-500 mb-1">è¨­å®šæ™‚é–“ (24å°æ™‚åˆ¶)</label>
                                            <input
                                                type="time"
                                                value={repeatTime}
                                                onChange={(e) => setRepeatTime(e.target.value)}
                                                className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                                required={isRepeating}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-500 mb-2">é¸æ“‡æ˜ŸæœŸ (å¯è¤‡é¸)</label>
                                            <div className="flex justify-between gap-2">
                                                {weekDays.map((day, idx) => (
                                                    <button
                                                        key={idx}
                                                        type="button"
                                                        onClick={() => toggleDay(idx)}
                                                        className={`w-full py-3 rounded-lg text-sm font-bold transition-all ${repeatDays.includes(idx)
                                                            ? 'bg-indigo-600 text-white shadow-md scale-105'
                                                            : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                                            }`}
                                                    >
                                                        {day}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    className={`w-full mt-2 text-white px-6 py-3 rounded-lg font-medium transition-all shadow-lg flex items-center justify-center gap-2 ${isRepeating ? 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'
                                        }`}
                                >
                                    <Plus className="w-5 h-5" />
                                    {isRepeating ? 'åŠ å…¥é‡è¤‡è¡Œç¨‹' : 'åŠ å…¥å–®æ¬¡æé†’'}
                                </button>
                            </form>
                        </div>

                        {/* åˆ—è¡¨å€ */}
                        <div className="space-y-4">
                            <h2 className="text-xl font-semibold text-slate-700 mb-4">
                                å¾…è¾¦æ¸…å–® ({reminders.filter(r => !r.completed || r.type === 'weekly').length})
                            </h2>

                            {reminders.map((item) => {
                                const display = getDisplayText(item);

                                return (
                                    <div
                                        key={item.id}
                                        className={`
                                            relative group flex items-center justify-between p-5 rounded-xl border transition-all duration-300
                                            ${item.completed && item.type !== 'weekly'
                                                ? 'bg-slate-50 border-slate-200 opacity-60'
                                                : display.isUrgent
                                                    ? 'bg-white border-red-200 shadow-md shadow-red-50 ring-1 ring-red-100'
                                                    : 'bg-white border-slate-200 shadow-sm hover:shadow-md'
                                            }
                                        `}
                                    >
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-1">
                                                <h3 className={`text-lg font-bold ${item.completed && item.type !== 'weekly' ? 'text-slate-500 line-through' : 'text-slate-800'}`}>
                                                    {item.title}
                                                </h3>
                                                {display.isUrgent && (
                                                    <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold animate-pulse">
                                                        å³å°‡é–‹å§‹
                                                    </span>
                                                )}
                                                {item.type === 'weekly' && (
                                                    <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded font-bold">
                                                        æ¯é€±é‡è¤‡
                                                    </span>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-4 text-sm">
                                                <span className="text-slate-500">
                                                    {display.time}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex flex-col items-end gap-2">
                                            <span className={`font-mono text-xl font-bold ${display.color}`}>
                                                {display.countdown}
                                            </span>

                                            <button
                                                onClick={() => handleDelete(item.id)}
                                                className="text-slate-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"
                                                title="åˆªé™¤æ­¤æé†’"
                                            >
                                                <Trash2 className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemindersApp />);
    </script>
</body>

</html>